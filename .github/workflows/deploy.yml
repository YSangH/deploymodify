name: CI/CD Pipeline for TheHabit (Bun)

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  # =============================================================
  # 1. ë¹Œë“œ ì¡ (CI) - ì½”ë“œ ê²€ì¦
  # =============================================================
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # .env íŒŒì¼ ìƒì„± (ë¹Œë“œìš©)
      - name: Create .env file for build
        run: |
          echo "NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}" > .env
          echo "KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}" >> .env
          echo "KAKAO_CLIENT_SECRET=${{ secrets.KAKAO_CLIENT_SECRET }}" >> .env
          echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" >> .env
          echo "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}" >> .env
          echo "NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}" >> .env
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> .env

      # Bun v1.2.19 ì„¤ì¹˜
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.2.19'

      # ì˜ì¡´ì„± ì„¤ì¹˜ ë° ë¹Œë“œ
      - name: Install dependencies and build with Bun
        run: |
          bun install
          bun run build

      # ë¹Œë“œ ê²°ê³¼ë¬¼ ìºì‹± (ì„±ëŠ¥ í–¥ìƒ)
      - name: Cache build artifacts
        uses: actions/cache@v3
        with:
          path: .next
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-

  # =============================================================
  # 2. ë°°í¬ ì¡ (CD) - ìë™ ë°°í¬
  # =============================================================
  deploy:
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.RLAND_HOST }}
          username: ${{ secrets.RLAND_USERNAME }}
          password: ${{ secrets.RLAND_PASSWORD }}
          port: ${{ secrets.RLAND_PORT }}
          script_timeout: "15m"      # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹œê°„ ì œí•œ
          command_timeout: "10m"     # ê°œë³„ ëª…ë ¹ì–´ ì‹¤í–‰ ì‹œê°„ ì œí•œ

          script: |
            # =============================================================
            # ì„œë²„ í™˜ê²½ ì„¤ì •
            # =============================================================
            echo "ğŸš€ ì„œë²„ í™˜ê²½ ì„¤ì • ì‹œì‘..."
            
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm use v22.4.0
            
            export BUN_INSTALL="$HOME/.bun"
            export PATH="$BUN_INSTALL/bin:$PATH"
            
            echo "âœ… Node.js $(node --version) ë° Bun $(bun --version) ì„¤ì • ì™„ë£Œ"

            # =============================================================
            # ì½”ë“œ ì—…ë°ì´íŠ¸
            # =============================================================
            echo "ğŸ“¥ ì½”ë“œ ì—…ë°ì´íŠ¸ ì‹œì‘..."
            
            mkdir -p ~/www
            cd ~/www
            
            if [ -d "TheHabit" ] ; then
              echo "ê¸°ì¡´ TheHabit ë””ë ‰í† ë¦¬ ë°œê²¬, ì—…ë°ì´íŠ¸ ì¤‘..."
              cd TheHabit
              git fetch origin
              git reset --hard origin/main
              echo "âœ… ì½”ë“œ ì—…ë°ì´íŠ¸ ì™„ë£Œ"
            else
              echo "ìƒˆë¡œìš´ TheHabit ë””ë ‰í† ë¦¬ ìƒì„± ì¤‘..."
              git clone https://github.com/FRONT-END-BOOTCAMP-PLUS-5/TheHabit.git
              cd TheHabit
              echo "âœ… ì½”ë“œ í´ë¡  ì™„ë£Œ"
            fi

            # =============================================================
            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
            # =============================================================
            echo "ğŸ” í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ì¤‘..."
            
            cat << EOF > .env
            # NextAuth.js Secret
            NEXTAUTH_SECRET="${{ secrets.NEXTAUTH_SECRET }}"
            
            # Kakao Login
            KAKAO_CLIENT_ID="${{ secrets.KAKAO_CLIENT_ID }}"
            KAKAO_CLIENT_SECRET="${{ secrets.KAKAO_CLIENT_SECRET }}"
            
            # Google Login
            GOOGLE_CLIENT_ID="${{ secrets.GOOGLE_CLIENT_ID }}"
            GOOGLE_CLIENT_SECRET="${{ secrets.GOOGLE_CLIENT_SECRET }}"
            
            # Database URL
            DATABASE_URL="${{ secrets.DATABASE_URL }}"
            
            # API URL
            NEXT_PUBLIC_API_URL="${{ secrets.NEXT_PUBLIC_API_URL }}"
            EOF
            
            echo "âœ… .env íŒŒì¼ ìƒì„± ì™„ë£Œ"

            # =============================================================
            # ì˜ì¡´ì„± ì„¤ì¹˜ ë° ë¹Œë“œ
            # =============================================================
            echo "ğŸ”¨ ì˜ì¡´ì„± ì„¤ì¹˜ ë° ë¹Œë“œ ì‹œì‘..."
            
            # ê¸°ì¡´ node_modules ì •ë¦¬ (ì„ íƒì‚¬í•­)
            rm -rf node_modules bun.lockb
            
            bun install
            bun run build
            
            echo "âœ… ë¹Œë“œ ì™„ë£Œ"

            # =============================================================
            # PM2 ì„œë¹„ìŠ¤ ë°°í¬
            # =============================================================
            echo "ï¿½ï¿½ PM2 ì„œë¹„ìŠ¤ ë°°í¬ ì‹œì‘..."
            
            # PM2 ì „ì—­ ì„¤ì¹˜
            npm install -g pm2
            
            # ê¸°ì¡´ ì„œë¹„ìŠ¤ ì •ë¦¬
            pm2 stop The-Habit || true
            pm2 delete The-Habit || true
            
            # ì‚¬ìš© ê°€ëŠ¥í•œ í¬íŠ¸ ì°¾ê¸° (í¬íŠ¸ ì¶©ëŒ ë°©ì§€)
            PORT=4444
            MAX_PORT=4500
            
            while [ $PORT -le $MAX_PORT ]; do
              if ! netstat -tuln | grep ":$PORT " > /dev/null 2>&1; then
                echo "âœ… í¬íŠ¸ $PORT ì‚¬ìš© ê°€ëŠ¥"
                break
              fi
              echo "âš ï¸ í¬íŠ¸ $PORT ì‚¬ìš© ì¤‘, ë‹¤ìŒ í¬íŠ¸ ì‹œë„..."
              PORT=$((PORT + 1))
            done
            
            if [ $PORT -gt $MAX_PORT ]; then
              echo "âŒ ì‚¬ìš© ê°€ëŠ¥í•œ í¬íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (4444-4500)"
              exit 1
            fi
            
            # ì„œë¹„ìŠ¤ ì‹œì‘
            echo "ï¿½ï¿½ TheHabit ì„œë¹„ìŠ¤ë¥¼ í¬íŠ¸ $PORTì—ì„œ ì‹œì‘ ì¤‘..."
            pm2 start bun --name "The-Habit" -- run start -- --port $PORT
            pm2 save
            
            # =============================================================
            # ë°°í¬ ê²€ì¦
            # =============================================================
            echo "ğŸ” ë°°í¬ ìƒíƒœ ê²€ì¦ ì¤‘..."
            
            # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
            sleep 10
            
            if pm2 list | grep "The-Habit" | grep "online" > /dev/null; then
              echo "âœ… ë°°í¬ ì„±ê³µ!"
              echo "ï¿½ï¿½ TheHabit ì„œë¹„ìŠ¤ê°€ í¬íŠ¸ $PORTì—ì„œ ì •ìƒ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤"
              echo "ğŸ“Š PM2 ìƒíƒœ:"
              pm2 list
            else
              echo "âŒ ë°°í¬ ì‹¤íŒ¨!"
              echo "ğŸ“‹ PM2 ë¡œê·¸:"
              pm2 logs The-Habit --lines 30
              echo "ğŸ“Š PM2 ìƒíƒœ:"
              pm2 list
              exit 1
            fi

      # =============================================================
      # ë°°í¬ ê²°ê³¼ ì•Œë¦¼
      # =============================================================
      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "ï¿½ï¿½ TheHabit ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
            echo "âœ… ë¹Œë“œ: ì„±ê³µ"
            echo "âœ… ë°°í¬: ì„±ê³µ"
            echo "ï¿½ï¿½ ì„œë¹„ìŠ¤ê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤"
          else
            echo "ğŸ’¥ TheHabit ë°°í¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤!"
            echo "âŒ ë¹Œë“œ: ${{ needs.build.result }}"
            echo "âŒ ë°°í¬: ${{ job.status }}"
            echo "ï¿½ï¿½ GitHub Actions ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”"
          fi

      # =============================================================
      # ë°°í¬ ì„±ê³µ ì‹œ ì¶”ê°€ ì‘ì—… (ì„ íƒì‚¬í•­)
      # =============================================================
      - name: Post-deployment tasks
        if: success()
        run: |
          echo "ğŸ¯ ë°°í¬ í›„ ì¶”ê°€ ì‘ì—… ì‹¤í–‰ ì¤‘..."
          echo "ğŸ“§ ì•Œë¦¼ ë°œì†¡, ëª¨ë‹ˆí„°ë§ ì„¤ì • ë“±..."
